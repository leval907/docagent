# üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AI Agent + Cube.js

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  OSV Excel      ‚îÇ
‚îÇ  Files          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì ETL Pipeline
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL         ‚îÇ
‚îÇ  history.osv_detail ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì get_profit_from_OSV.py
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GigaChat (LLM)     ‚îÇ
‚îÇ  Analyzes & Calcs   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì Saves JSON
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL         ‚îÇ
‚îÇ  analytics.profit_v ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì Cube.js Model
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ProfitAndLoss.js   ‚îÇ
‚îÇ  Semantic Layer     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì Queries
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DataLens / BI      ‚îÇ
‚îÇ  Dashboards         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ß—Ç–æ –¥–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è?

### ‚úÖ –ë–µ–∑ Cube.js (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∞–≥–µ–Ω—Ç–∞):
- –î–∞–Ω–Ω—ã–µ P&L —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ `analytics.profit_v`
- –ù—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ (margins, EBITDA) –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ API –¥–ª—è –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π

### ‚úÖ –° Cube.js (–ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏):
- **–ï–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö** - –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –æ–¥–∏–Ω —Ä–∞–∑
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã** - gross margin, net margin, EBITDA
- **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API** - REST/GraphQL/SQL –¥–ª—è –≤—Å–µ—Ö –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - pre-aggregations —É—Å–∫–æ—Ä—è—é—Ç –∑–∞–ø—Ä–æ—Å—ã
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã –≤–µ–∑–¥–µ

---

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Cube.js –º–æ–¥–µ–ª–∏

–ú–æ–¥–µ–ª—å `ProfitAndLoss.js` —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –≤ `/opt/docagent/mycube-docker/model/financial/`

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

### üìä Measures (–ú–µ—Ç—Ä–∏–∫–∏)

**–ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `totalRevenue` - –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
- `totalCostOfGoods` - –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
- `totalOverheads` - –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã

**–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å:**
- `grossProfit` - –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å
- `grossProfitMargin` - –í–∞–ª–æ–≤–∞—è –º–∞—Ä–∂–∞ %
- `operatingProfit` - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (EBIT)
- `operatingMargin` - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ä–∂–∞ %
- `netProfit` - –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å
- `netMargin` - –ß–∏—Å—Ç–∞—è –º–∞—Ä–∂–∞ %
- `ebitda` - EBITDA
- `ebitdaMargin` - EBITDA –º–∞—Ä–∂–∞ %

**–†–∞—Å—Ö–æ–¥—ã:**
- `totalLeasing` - –õ–∏–∑–∏–Ω–≥
- `totalInterest` - –ü—Ä–æ—Ü–µ–Ω—Ç—ã
- `totalDepreciation` - –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è
- `totalTax` - –ù–∞–ª–æ–≥–∏
- `totalDividends` - –î–∏–≤–∏–¥–µ–Ω–¥—ã

### üéØ Segments (–°–µ–≥–º–µ–Ω—Ç—ã)

- `profitable` - –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (net profit > 0)
- `unprofitable` - –£–±—ã—Ç–æ—á–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (net profit <= 0)
- `highMargin` - –í—ã—Å–æ–∫–æ–º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–µ (gross margin > 30%)
- `hasInterest` - –ö–æ–º–ø–∞–Ω–∏–∏ —Å –¥–æ–ª–≥–æ–º (interest paid > 0)
- `paysDividends` - –í—ã–ø–ª–∞—á–∏–≤–∞—é—Ç –¥–∏–≤–∏–¥–µ–Ω–¥—ã

### üîó Joins (–°–≤—è–∑–∏)

- `Companies` - –°–≤—è–∑—å —Å –∫–æ–º–ø–∞–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ `company_code`

---

## –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ Cube.js —Å –Ω–æ–≤–æ–π –º–æ–¥–µ–ª—å—é

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å docker-compose
cat /opt/docagent/mycube-docker/docker-compose.yml

# –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞—Ç—å
cat > /opt/docagent/mycube-docker/docker-compose.yml << 'EOF'
version: '3.8'

services:
  cube:
    image: cubejs/cube:latest
    ports:
      - "4000:4000"   # Cube Playground
      - "15432:15432" # SQL API
    environment:
      - CUBEJS_DEV_MODE=true
      - CUBEJS_DB_TYPE=postgres
      - CUBEJS_DB_HOST=host.docker.internal
      - CUBEJS_DB_PORT=5432
      - CUBEJS_DB_NAME=analytics
      - CUBEJS_DB_USER=analytics_user
      - CUBEJS_DB_PASS=analytics_secure_2025
      - CUBEJS_API_SECRET=cube_secret_key_2025
    volumes:
      - ./model:/cube/conf/model
      - ./.cubestore:/cube/conf/.cubestore
    networks:
      - analytics
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  analytics:
    driver: bridge
EOF
```

### –ó–∞–ø—É—Å–∫ Cube.js

```bash
cd /opt/docagent/mycube-docker
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose logs -f cube
```

Cube.js –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞:
- **Playground**: http://localhost:4000
- **SQL API**: localhost:15432

---

## –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Cube Playground

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:4000 –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã:

### –ó–∞–ø—Ä–æ—Å 1: –¢–æ–ø –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –≤—ã—Ä—É—á–∫–µ

```javascript
{
  "measures": [
    "ProfitAndLoss.totalRevenue",
    "ProfitAndLoss.grossProfit",
    "ProfitAndLoss.grossProfitMargin"
  ],
  "dimensions": [
    "ProfitAndLoss.companyName"
  ],
  "order": {
    "ProfitAndLoss.totalRevenue": "desc"
  },
  "limit": 10
}
```

### –ó–∞–ø—Ä–æ—Å 2: –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ vs —É–±—ã—Ç–æ—á–Ω—ã–µ

```javascript
{
  "measures": [
    "ProfitAndLoss.count",
    "ProfitAndLoss.totalRevenue",
    "ProfitAndLoss.netProfit"
  ],
  "segments": [
    "ProfitAndLoss.profitable"
  ]
}
```

### –ó–∞–ø—Ä–æ—Å 3: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã

```javascript
{
  "measures": [
    "ProfitAndLoss.grossProfitMargin",
    "ProfitAndLoss.operatingMargin",
    "ProfitAndLoss.netMargin",
    "ProfitAndLoss.ebitdaMargin"
  ],
  "dimensions": [
    "ProfitAndLoss.companyName"
  ],
  "filters": [
    {
      "member": "ProfitAndLoss.revenue",
      "operator": "gt",
      "values": ["1000000"]
    }
  ]
}
```

---

## –®–∞–≥ 4: SQL API –¥–ª—è DataLens

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Cube.js –∫–∞–∫ –∫ PostgreSQL:

```yaml
Host: localhost
Port: 15432
Database: db
Username: cube
Password: cube_secret_key_2025
SSL: disabled
```

### –ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤

```sql
-- –¢–æ–ø 10 –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏
SELECT 
  company_name,
  total_revenue,
  net_profit,
  net_margin
FROM ProfitAndLoss
ORDER BY net_profit DESC
LIMIT 10;

-- –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
SELECT 
  COUNT(*) as companies,
  SUM(total_revenue) as total_revenue,
  SUM(net_profit) as total_net_profit,
  AVG(net_margin) as avg_margin
FROM ProfitAndLoss
WHERE __segment = 'profitable';

-- –ö–æ–º–ø–∞–Ω–∏–∏ —Å –¥–æ–ª–≥–æ–º
SELECT 
  company_name,
  total_interest,
  total_revenue,
  (total_interest / NULLIF(total_revenue, 0)) * 100 as interest_burden_pct
FROM ProfitAndLoss
WHERE __segment = 'hasInterest'
ORDER BY interest_burden_pct DESC;
```

---

## –®–∞–≥ 5: REST API –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

### Endpoint

```
POST http://localhost:4000/cubejs-api/v1/load
Authorization: Bearer cube_secret_key_2025
Content-Type: application/json
```

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (curl)

```bash
curl -X POST \
  http://localhost:4000/cubejs-api/v1/load \
  -H 'Authorization: Bearer cube_secret_key_2025' \
  -H 'Content-Type: application/json' \
  -d '{
    "query": {
      "measures": [
        "ProfitAndLoss.totalRevenue",
        "ProfitAndLoss.netProfit",
        "ProfitAndLoss.netMargin"
      ],
      "dimensions": [
        "ProfitAndLoss.companyName"
      ],
      "order": {
        "ProfitAndLoss.totalRevenue": "desc"
      },
      "limit": 5
    }
  }'
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

```json
{
  "data": [
    {
      "ProfitAndLoss.companyName": "–ì–†–û–°–° –ì–†–£–ü –î–ò –û–û–û",
      "ProfitAndLoss.totalRevenue": "150000000.50",
      "ProfitAndLoss.netProfit": "25000000.00",
      "ProfitAndLoss.netMargin": "16.67"
    },
    ...
  ]
}
```

---

## –®–∞–≥ 6: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞

–°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞:

```bash
#!/bin/bash
# full_pipeline.sh - –û—Ç Excel –¥–æ Cube.js

set -e

echo "üì• Step 1: Import OSV data from Excel"
python3 scripts/finance/etl/import_osv.py /opt/docagent/data/osv_revenue_0925/input/

echo "ü§ñ Step 2: Run AI Agent for P&L generation"
companies=(
    "GROSS_GRUP_DI"
    "VAITERA"
    "PARTNER"
    "GLOBALKONSALT"
)

for company in "${companies[@]}"; do
    echo "  Processing $company..."
    python3 scripts/finance/get_profit_from_OSV.py "$company"
    sleep 3
done

echo "‚ôªÔ∏è Step 3: Refresh Cube.js cache"
curl -X POST \
  http://localhost:4000/cubejs-api/v1/pre-aggregations/jobs \
  -H "Authorization: Bearer cube_secret_key_2025" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "post",
    "selector": {
      "contexts": [
        {"securityContext": {}}
      ]
    }
  }'

echo "‚úÖ Pipeline complete! Data available in Cube.js"
echo "   Playground: http://localhost:4000"
echo "   SQL API: localhost:15432"
```

–ó–∞–ø—É—Å–∫:
```bash
chmod +x full_pipeline.sh
./full_pipeline.sh
```

---

## –®–∞–≥ 7: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Cube.js

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞
curl http://localhost:4000/cubejs-api/v1/meta \
  -H "Authorization: Bearer cube_secret_key_2025" | jq '.cubes[] | select(.name == "ProfitAndLoss")'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å SQL API
PGPASSWORD=cube_secret_key_2025 psql -h localhost -p 15432 -U cube -d db -c "SHOW CUBES;"
```

### –õ–æ–≥–∏ Cube.js

```bash
# –í—Å–µ –ª–æ–≥–∏
docker-compose logs -f cube

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
docker-compose logs cube | grep ERROR

# SQL –∑–∞–ø—Ä–æ—Å—ã
docker-compose logs cube | grep "SQL"
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Use Case 1: Dashboard –≤ DataLens

1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Cube SQL API (localhost:15432)
2. –°–æ–∑–¥–∞—Ç—å –¥–∞—Ç–∞—Å–µ—Ç —Å –∑–∞–ø—Ä–æ—Å–æ–º:
```sql
SELECT 
  company_name,
  total_revenue,
  gross_profit_margin,
  operating_margin,
  net_margin,
  ebitda_margin
FROM ProfitAndLoss
WHERE total_revenue > 0
```
3. –°–æ–∑–¥–∞—Ç—å —á–∞—Ä—Ç—ã:
   - Bar chart: Revenue by company
   - Scatter: Operating margin vs Revenue
   - Table: Top profitable companies

### Use Case 2: Telegram Bot —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏

```python
import requests

CUBE_API = "http://localhost:4000/cubejs-api/v1/load"
HEADERS = {
    "Authorization": "Bearer cube_secret_key_2025",
    "Content-Type": "application/json"
}

def get_company_metrics(company_name):
    query = {
        "measures": [
            "ProfitAndLoss.totalRevenue",
            "ProfitAndLoss.netProfit",
            "ProfitAndLoss.netMargin"
        ],
        "dimensions": ["ProfitAndLoss.companyName"],
        "filters": [{
            "member": "ProfitAndLoss.companyName",
            "operator": "contains",
            "values": [company_name]
        }]
    }
    
    response = requests.post(CUBE_API, headers=HEADERS, json={"query": query})
    return response.json()["data"][0]

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
metrics = get_company_metrics("–ì–†–û–°–° –ì–†–£–ü")
print(f"Revenue: {metrics['ProfitAndLoss.totalRevenue']}")
print(f"Net Profit: {metrics['ProfitAndLoss.netProfit']}")
print(f"Margin: {metrics['ProfitAndLoss.netMargin']}%")
```

### Use Case 3: Excel –æ—Ç—á–µ—Ç –∏–∑ Cube.js

```python
import pandas as pd
import requests

response = requests.post(
    "http://localhost:4000/cubejs-api/v1/load",
    headers={"Authorization": "Bearer cube_secret_key_2025"},
    json={
        "query": {
            "measures": [
                "ProfitAndLoss.totalRevenue",
                "ProfitAndLoss.grossProfit",
                "ProfitAndLoss.netProfit"
            ],
            "dimensions": ["ProfitAndLoss.companyName"]
        }
    }
)

df = pd.DataFrame(response.json()["data"])
df.to_excel("/tmp/profit_report.xlsx", index=False)
print("‚úÖ Report saved to /tmp/profit_report.xlsx")
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- **AI Agent** - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ insights –∏–∑ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Cube.js** - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Å–ª–æ–π –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
- **PostgreSQL** - –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- **BI Tools** - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

### 2. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ - —Ç–æ–ª—å–∫–æ –≤ Cube.js –º–æ–¥–µ–ª–∏
- –ù–æ–≤—ã–µ –∞–≥–µ–Ω—Ç—ã –ø–∏—à—É—Ç –≤ —Å–≤–æ–∏ —Ç–∞–±–ª–∏—Ü—ã
- Cube.js –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å—ë —á–µ—Ä–µ–∑ joins

### 3. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –û–¥–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ gross margin –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ - –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –º–µ–∂–¥—É –æ—Ç—á–µ—Ç–∞–º–∏

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- Pre-aggregations –∫—ç—à–∏—Ä—É—é—Ç —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- SQL API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à Cube.js
- –ê–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

---

## Troubleshooting

### Cube.js –Ω–µ –≤–∏–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É profit_v

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
Error: relation "analytics.profit_v" does not exist
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
PGPASSWORD=analytics_secure_2025 psql -h localhost -U analytics_user -d analytics -c "\dt analytics.*"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Cube.js –∫ –ë–î
docker-compose logs cube | grep "connection"
```

### –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Cube.js

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç []

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
PGPASSWORD=analytics_secure_2025 psql -h localhost -U analytics_user -d analytics -c \
"SELECT COUNT(*) FROM analytics.profit_v;"

# –ï—Å–ª–∏ 0, –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞
python3 scripts/finance/get_profit_from_OSV.py "GROSS_GRUP_DI"
```

### –û—à–∏–±–∫–∞ "Cannot read property 'sql' of undefined"

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –º–æ–¥–µ–ª–∏

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å JS
cd /opt/docagent/mycube-docker/model/financial
node -c ProfitAndLoss.js

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Cube.js
docker-compose logs cube | grep "ProfitAndLoss"
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `ProfitAndLoss.js` - **–ì–æ—Ç–æ–≤–æ**
2. ‚è≥ –ó–∞–ø—É—Å—Ç–∏—Ç—å Cube.js —Å –Ω–æ–≤–æ–π –º–æ–¥–µ–ª—å—é
3. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ Playground
4. ‚è≥ –ü–æ–¥–∫–ª—é—á–∏—Ç—å DataLens –∫ SQL API
5. ‚è≥ –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
6. ‚è≥ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (cron)
7. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –∞–≥–µ–Ω—Ç—ã (balance sheet, cash flow)

---

**–î–∞—Ç–∞:** 2025-11-24  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
