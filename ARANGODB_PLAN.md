# План развития структуры ArangoDB и аналитики

В связи с планируемой загрузкой большого количества таблиц, предлагается расширить схему графа для поддержки более глубокого финансового анализа.

## 1. Структура Коллекций (Schema)

### Вершины (Document Collections)

1.  **`Companies`** (Компании)
    *   Сущности: Юридические лица (наши и контрагенты).
    *   Поля:
        *   `_key`: Hash(INN) или Hash(Name)
        *   `name`: Название
        *   `inn`: ИНН
        *   `type`: 'internal' (группа) / 'external' (контрагент)
        *   `industry`: Отрасль (если есть)

2.  **`Accounts`** (План Счетов)
    *   Сущности: Бухгалтерские счета (РСБУ).
    *   Поля:
        *   `_key`: Номер счета (например, "51", "60.01")
        *   `name`: Название ("Расчетные счета")
        *   `type`: 'Active', 'Passive', 'Active-Passive'
        *   `balance_line`: Код строки баланса (например, "1250")
        *   `balance_section`: Раздел баланса ("Оборотные активы")

3.  **`CostItems`** (Статьи затрат и ДДС)
    *   Сущности: Аналитические статьи для ПУ (P&L) и ДДС (Cash Flow).
    *   Поля:
        *   `name`: Название статьи
        *   `report_type`: 'DDS' (ДДС) / 'OPU' (ОПУ) / 'BOTH'
        *   `section`: Раздел отчета (например, "Операционная деятельность", "Себестоимость")
        *   `is_variable`: Переменные/Постоянные (для Unit-экономики)

4.  **`Contracts`** (Договоры)
    *   Сущности: Договоры между компаниями.
    *   Поля:
        *   `number`: Номер договора
        *   `date_start`: Дата начала
        *   `date_end`: Дата окончания
        *   `amount`: Сумма договора
        *   `category`: Тип (Поставка, Услуги, Аренда и т.д.)

5.  **`Projects`** (Проекты)
    *   Сущности: Бизнес-проекты или направления (например, "ЖК Южный", "Завод №1").
    *   Поля:
        *   `name`: Название проекта
        *   `manager`: Ответственный

### Ребра (Edge Collections)

1.  **`Transactions`** (Транзакции / Проводки)
    *   Направление: `Payer` -> `Payee` (для ДДС) или `Source` -> `Destination` (для начисления).
    *   Поля:
        *   `amount`: Сумма
        *   `date`: Дата
        *   `dt`: Счет дебета (ссылка на `Accounts`)
        *   `kt`: Счет кредита (ссылка на `Accounts`)
        *   `cost_item_id`: Ссылка на статью (из `CostItems`)
        *   `is_intercompany`: boolean (Флаг внутригруппового оборота для элиминации)

2.  **`ClassifiedAs`** (Классификация)
    *   Направление: `Transaction` -> `CostItem` (если транзакция моделируется как вершина)
    *   *Примечание*: Для оптимизации лучше хранить `cost_item_id` внутри ребра `Transactions`.

3.  **`SignedBy`** (Подписанты)
    *   Направление: `Company` -> `Contract`
    *   Смысл: Какая компания является стороной договора.
    *   Поля: `role` ('customer', 'contractor')

4.  **`AllocatedTo`** (Привязка к проекту)
    *   Направление: `Contract` / `Transaction` -> `Project`
    *   Смысл: Разнесение затрат и доходов по проектам.

5.  **`Ownership`** (Владение / Структура группы)
    *   Направление: `ParentCompany` -> `ChildCompany`
    *   Смысл: Юридическая структура владения для консолидации.

## 2. Стратегия Анализа (AQL Queries)

С помощью ArangoDB (AQL) мы сможем выполнять следующие виды анализа, недоступные в обычном SQL:

### А. Элиминация Внутригрупповых Оборотов (Elimination)
Исключение оборотов между компаниями группы для получения консолидированной отчетности.
```aql
// Расчет консолидированной выручки (без ВГО)
FOR t IN Transactions
    // Получаем отправителя и получателя
    LET sender = DOCUMENT(t._from)
    LET receiver = DOCUMENT(t._to)
    
    // Фильтр: Исключаем, если оба участника внутри группы
    FILTER NOT (sender.type == 'internal' AND receiver.type == 'internal')
    
    COLLECT AGGREGATE revenue = SUM(t.amount)
    RETURN revenue
```

### Б. Формирование ДДС (Cash Flow)
Сборка отчета прямым методом на лету.
```aql
FOR t IN Transactions
    FILTER t.dt == '51' OR t.dt == '50' // Поступление денег
    LET article = DOCUMENT(CONCAT('CostItems/', t.cost_item_id))
    
    COLLECT 
        section = article.section, 
        item = article.name 
    AGGREGATE 
        total = SUM(t.amount)
    
    RETURN { section, item, total }
```

### В. Анализ цепочек платежей (Traceability)
Отслеживание движения денег через несколько посредников.
```aql
// Найти, куда ушли деньги от Компании А через 2-3 колена
FOR v, e, p IN 1..3 OUTBOUND 'Companies/CompanyA' Transactions
    RETURN p
```

### Г. Выявление скрытых связей (Common Neighbors)
Поиск контрагентов, которые работают одновременно с несколькими нашими компаниями (потенциал для скидок или риск сговора).
```aql
// Найти контрагентов, получающих деньги от >2 наших компаний
FOR doc IN Companies
    FILTER doc.type == 'external'
    LET payers = (
        FOR v, e IN INBOUND doc Transactions
        RETURN v._id
    )
    FILTER LENGTH(UNIQUE(payers)) > 2
    RETURN { counterparty: doc.name, payers: UNIQUE(payers) }
```

## 3. План реализации

1.  **Этап 1 (Текущий)**:
    *   Загрузка ОСВ.
    *   Вершины: `Companies`.
    *   Ребра: `Transactions` (агрегированные).
    *   Цель: Визуализация основных потоков выручки.

2.  **Этап 2 (Финансовая модель)**:
    *   Создание справочников `Accounts` и `CostItems`.
    *   Настройка маппинга: Проводка (Дт/Кт) -> Статья.
    *   Реализация логики элиминации (маркировка транзакций).

3.  **Этап 3 (Детализация)**:
    *   Загрузка реестров договоров.
    *   Создание коллекции `Contracts`.
    *   Линковка транзакций к договорам.

4.  **Этап 4 (Проектный учет)**:
    *   Внедрение справочника проектов.
    *   Разметка транзакций по проектам (автоматически по назначению платежа или вручную).

