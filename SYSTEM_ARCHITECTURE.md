# System Architecture & Implementation Status

## 1. Обзор системы
Система **DocAgent Finance** предназначена для глубокого финансового анализа предприятий на основе данных РСБУ, управленческой отчетности и неструктурированных текстовых документов (методик).

Ядро системы построено на гибридной архитектуре:
*   **DuckDB**: OLAP-хранилище для сырых данных (ОСВ, Excel).
*   **ArangoDB**: Графовая база данных для моделирования связей (Компании, Счета, Транзакции).
*   **RAG (Retrieval-Augmented Generation)**: Векторный поиск по методическим документам для автоматизации расчетов.

## 2. Архитектура Базы Данных (ArangoDB)
База данных: `finance_analytics`

### Коллекции (Vertices)
*   **Companies**: Юридические лица и контрагенты.
*   **Accounts**: План счетов (РСБУ) с расширенной классификацией (Группы ликвидности A1-A4, P1-P4).
*   **CostItems**: Статьи затрат и движения денежных средств.
*   **Documents**: Методические документы (Markdown).
*   **document_chunks**: Векторизованные фрагменты документов (RAG).

### Связи (Edges)
*   **Transactions**: Финансовые проводки (Счет 60, 62).
*   **Incurred**: Понесенные расходы (20, 26, 44) и денежные потоки (51).
*   **ChunkOf**: Связь фрагмента с родительским документом.
*   **Mentions**: Семантическая связь документа с конкретными счетами (автоматически извлекается из текста).

## 3. Реализованные Пайплайны (Pipelines)

### A. ETL Pipeline (Excel -> DuckDB -> ArangoDB)
1.  **Import**: Парсинг Excel-файлов ОСВ (счета 20, 26, 44, 51, 60, 91) в DuckDB.
2.  **Normalization**: Очистка названий компаний, дедупликация.
3.  **Graph Sync**: Миграция данных в ArangoDB с созданием узлов и ребер.

### B. RAG Pipeline (Methodology -> Knowledge Graph)
1.  **Ingestion**: Загрузка Markdown-документов (методики анализа).
2.  **Chunking**: Разбиение на смысловые фрагменты (Header-based + Recursive).
3.  **Embedding**: Генерация векторов с помощью модели `all-MiniLM-L6-v2`.
4.  **Linking**: Автоматический поиск упоминаний счетов (regex) и создание ребер `Mentions`.

### C. Analytics Pipeline (AI Analyst)
1.  **Query Understanding**: Векторный поиск релевантной методики по запросу пользователя.
2.  **Data Retrieval**: Извлечение финансовых данных из Графа (ArangoDB).
3.  **Calculation**: Расчет показателей (Ликвидность, Power of One) на основе найденной методики и данных.

## 4. Технологический Стек
*   **Язык**: Python 3.12
*   **Базы данных**:
    *   ArangoDB (Graph)
    *   DuckDB (OLAP)
*   **AI & ML**:
    *   `sentence-transformers` (Embeddings)
    *   `langchain` (Text Splitting)
    *   `pandas` (Data Manipulation)
*   **Инфраструктура**: Docker, Linux

## 5. Текущий статус (Stage 2 Complete)
*   ✅ **Data Layer**: Все данные ОСВ загружены и структурированы в Графе.
*   ✅ **Knowledge Layer**: Методики ("Сила одного", "Ликвидность") загружены и векторизованы.
*   ✅ **Semantic Layer**: Документы связаны со счетами.
*   ✅ **Analytics Layer**: Реализован прототип агента, который считает фин. показатели по запросу на естественном языке.

## 6. Следующие шаги
*   Расширение базы методик.
*   Интеграция с LLM (GigaChat/OpenAI) для генерации текстовых выводов.
*   Создание API для фронтенда.
