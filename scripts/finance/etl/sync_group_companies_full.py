#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –≥—Ä—É–ø–ø—ã –∏–∑ Excel –≤ ArangoDB.
–ò—Å—Ç–æ—á–Ω–∏–∫: data/osv_revenue_0925/input/–ì—Ä—É–ø–ø–∞ –ö–æ–º–ø–∞–Ω–∏–π_–ê.xlsx

–õ–æ–≥–∏–∫–∞:
1. –ß–∏—Ç–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ (23 –∫–æ–º–ø–∞–Ω–∏–∏).
2. –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ ArangoDB (–∫–æ–ª–ª–µ–∫—Ü–∏—è Companies).
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ is_group = True.
4. –î–æ–±–∞–≤–ª—è–µ—Ç –∞–ª–∏–∞—Å—ã –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ì–ì–î–ò -> –ì–†–û–°–° –ì–†–£–ü –î–ò –û–û–û).
"""

import pandas as pd
import sys
import re
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞
sys.path.append('/opt/docagent')
from finance_core.db.connector import DBManager

EXCEL_PATH = Path("/opt/docagent/data/osv_revenue_0925/input/–ì—Ä—É–ø–ø–∞ –ö–æ–º–ø–∞–Ω–∏–π_–ê.xlsx")

# –†—É—á–Ω–æ–π –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∞—Å–∏–≤—ã—Ö –∫–ª—é—á–µ–π –∏ –∞–ª–∏–∞—Å–æ–≤
# Key: Legal Name from Excel -> Value: (Arango Key, Short Name, [Aliases])
KNOWN_MAPPING = {
    "–ì–†–û–°–° –ì–†–£–ü –î–ò –û–û–û": ("GGDI", "–ì–ì–î–ò", ["–ì–ì–î–ò", "GROSS GROUP DI"]),
    "–ì–†–û–°–° –ì–†–£–ü –ú –û–û–û": ("GGM", "–ì–ì–ú", ["–ì–ì–ú", "GROSS GROUP M"]),
    "–Æ–ì –ò–°–¢–ï–ô–¢ –ò–ù–ñ–ò–ù–ò–†–ò–ù–ì –û–û–û": ("YUG_ISTEYT", "–Æ–≥-–ò—Å—Ç–µ–π—Ç", ["–Æ–≥-–ò—Å—Ç–µ–π—Ç", "YUG ESTATE"]),
    "–°–ì–ö-–†–ï–ì–ò–û–ù –û–û–û": ("SGK_REGION", "–°–ì–ö-–†–µ–≥–∏–æ–Ω", ["–°–ì–ö-–†–µ–≥–∏–æ–Ω"]),
    "–í–õ–ê–î–ï–ù–ò–ï-–í –û–û–û": ("VLADENIE_V", "–í–ª–∞–¥–µ–Ω–∏–µ-–í", ["–í–ª–∞–¥–µ–Ω–∏–µ-–í"]),
    "–î–ñ–£–õ –õ–ê–ô–§ –û–û–û": ("DZHUL_LAYF", "–î–∂—É–ª –õ–∞–π—Ñ", ["–î–∂—É–ª –õ–∞–π—Ñ"]),
    "–£–ö –ì–†–û–°–° –û–û–û": ("UK_GROSS", "–£–ö –ì—Ä–æ—Å—Å", ["–£–ö –ì—Ä–æ—Å—Å"]),
    "–®–ò–ù–î–Ø–ü–ò–ù –ê.–í. –ò–ü": ("SHINDYAPIN", "–ò–ü –®–∏–Ω–¥—è–ø–∏–Ω", ["–®–∏–Ω–¥—è–ø–∏–Ω", "–ò–ü –®–∏–Ω–¥—è–ø–∏–Ω –ê.–í."]),
    "–í–ê–ô–¢–ï–†–ê –û–û–û": ("VAYTERA", "–í–∞–π—Ç–µ—Ä–∞", ["–í–∞–π—Ç–µ—Ä–∞"]),
    "–í–§–¶ –û–û–û": ("VFTS", "–í–§–¶", ["–í–§–¶"]),
    "–ì–†–ê–ù–î–ü–†–û–ú –ê–û": ("GRANDPROM", "–ì—Ä–∞–Ω–¥–ø—Ä–æ–º", ["–ì—Ä–∞–Ω–¥–ø—Ä–æ–º"]),
    "–ê–õ–¨–Ø–ù–° –û–û–û": ("ALYANS", "–ê–ª—å—è–Ω—Å", ["–ê–ª—å—è–Ω—Å"]),
    "–ë–û–° –û–û–û": ("BOS", "–ë–æ—Å", ["–ë–æ—Å"]),
    "–ö-–°–¢–†–û–ô –ê–û": ("K_STROY", "–ö-–°—Ç—Ä–æ–π", ["–ö-–°—Ç—Ä–æ–π"]),
    "–ú–û–ù–û–õ–ò–¢ –û–û–û": ("MONOLIT", "–ú–æ–Ω–æ–ª–∏—Ç", ["–ú–æ–Ω–æ–ª–∏—Ç"]),
    "–§–ï–¢–ï–† –û–û–û": ("FETER", "–§–µ—Ç–µ—Ä", ["–§–µ—Ç–µ—Ä"]),
    "–õ–ï–°–ù–û–ï –û–û–û": ("LESNOE", "–õ–µ—Å–Ω–æ–µ", ["–õ–µ—Å–Ω–æ–µ"]),
    "–õ–ò–¢–û–†–£–° –û–û–û": ("LITORUS", "–õ–∏—Ç–æ—Ä—É—Å", ["–õ–∏—Ç–æ—Ä—É—Å"]),
    "–ü–ê–†–¢–ù–ï–† –û–û–û": ("PARTNER", "–ü–∞—Ä—Ç–Ω–µ—Ä", ["–ü–∞—Ä—Ç–Ω–µ—Ä"]),
    "–¢–ï–ö–¢–û–ù–ò–ö–ê –û–û–û": ("TEKTONIKA", "–¢–µ–∫—Ç–æ–Ω–∏–∫–∞", ["–¢–µ–∫—Ç–æ–Ω–∏–∫–∞"]),
    "–í–û–†–ü–ê–õ –ó–ê–û": ("VORPAL", "–í–æ—Ä–ø–∞–ª", ["–í–æ—Ä–ø–∞–ª"]),
    "–ì–õ–û–ë–ê–õ–ö–û–ù–°–ê–õ–¢ –û–û–û": ("GLOBALCONSULT", "–ì–ª–æ–±–∞–ª–∫–æ–Ω—Å–∞–ª—Ç", ["–ì–ª–æ–±–∞–ª–∫–æ–Ω—Å–∞–ª—Ç"]),
    "–†–ï–ö–†–ï–ê–¶–ò–û–ù–ù–´–ï –°–ò–°–¢–ï–ú–´ –û–û–û": ("RECREATION_SYSTEMS", "–†–µ–∫—Ä–µ–∞—Ü–∏–æ–Ω–Ω—ã–µ –°–∏—Å—Ç–µ–º—ã", ["–†–µ–∫—Ä–µ–∞—Ü–∏–æ–Ω–Ω—ã–µ –°–∏—Å—Ç–µ–º—ã"]),
    # –ù–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –û–°–í 9 –º–µ—Å
    "–ó–û–†–ì –û–û–û": ("ZORG", "–ó–æ—Ä–≥", ["–ó–æ—Ä–≥", "–û–û–û –ó–û–†–ì"]),
    "–ò–ù–í–ï–°–¢-–°–¢–†–û–ô –û–û–û": ("INVEST_STROY", "–ò–Ω–≤–µ—Å—Ç-–°—Ç—Ä–æ–π", ["–ò–Ω–≤–µ—Å—Ç-–°—Ç—Ä–æ–π", "–û–û–û –ò–ù–í–ï–°–¢-–°–¢–†–û–ô"])
}

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ Excel, –Ω–æ –µ—Å—Ç—å –≤ —Ñ–∞–π–ª–∞—Ö –û–°–í
EXTRA_COMPANIES = [
    "–ó–û–†–ì –û–û–û",
    "–ò–ù–í–ï–°–¢-–°–¢–†–û–ô –û–û–û"
]

def transliterate(text):
    """–ü—Ä–æ—Å—Ç–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π, –µ—Å–ª–∏ –Ω–µ—Ç –≤ –º–∞–ø–ø–∏–Ω–≥–µ"""
    mapping = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
        '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
        '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
        '—Ñ': 'f', '—Ö': 'kh', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'shch',
        '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya',
        ' ': '_', '-': '_'
    }
    result = ''
    for char in text.lower():
        result += mapping.get(char, char)
    return re.sub(r'[^a-zA-Z0-9_]', '', result).upper()

def sync_full_group():
    print("="*80)
    print("üöÄ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π –≥—Ä—É–ø–ø—ã –∫–æ–º–ø–∞–Ω–∏–π (Excel -> ArangoDB)")
    print("="*80)

    # 1. –ß—Ç–µ–Ω–∏–µ Excel
    if not EXCEL_PATH.exists():
        print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {EXCEL_PATH}")
        return

    df = pd.read_excel(EXCEL_PATH)
    col_name = '–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π' if '–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π' in df.columns else df.columns[0]
    companies_raw = df[col_name].dropna().tolist()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
    print(f"‚ûï –î–æ–±–∞–≤–ª—è–µ–º {len(EXTRA_COMPANIES)} –Ω–æ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ –û–°–í")
    companies_raw.extend(EXTRA_COMPANIES)
    
    print(f"üìÇ –í—Å–µ–≥–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {len(companies_raw)} –∫–æ–º–ø–∞–Ω–∏–π")

    # 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ArangoDB
    db = DBManager().get_arango_db()
    if not db.has_collection('Companies'):
        db.create_collection('Companies')
    coll = db.collection('Companies')

    # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞
    updated_count = 0
    created_count = 0

    for raw_name in companies_raw:
        clean_name = raw_name.strip()
        upper_name = clean_name.upper()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if upper_name in KNOWN_MAPPING:
            key, short_name, aliases = KNOWN_MAPPING[upper_name]
        else:
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –µ—Å–ª–∏ –Ω–µ—Ç –≤ –º–∞–ø–ø–∏–Ω–≥–µ
            key = transliterate(clean_name)
            short_name = clean_name
            aliases = [clean_name]
            print(f"‚ö†Ô∏è  –ù–µ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ –¥–ª—è '{clean_name}', —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á: {key}")

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º legal_name –≤ –∞–ª–∏–∞—Å—ã
        if clean_name not in aliases:
            aliases.append(clean_name)
        if upper_name not in aliases:
            aliases.append(upper_name)

        doc = {
            '_key': key,
            'name': short_name,       # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            'legal_name': clean_name, # –ü–æ–ª–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –∏–º—è
            'aliases': list(set(aliases)), # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–ª–∏–∞—Å—ã
            'is_group': True,
            'source': '–ì—Ä—É–ø–ø–∞ –ö–æ–º–ø–∞–Ω–∏–π_–ê.xlsx'
        }

        # Upsert
        if coll.has(key):
            coll.update(doc)
            updated_count += 1
            # print(f"   üîÑ –û–±–Ω–æ–≤–ª–µ–Ω: {short_name} ({key})")
        else:
            coll.insert(doc)
            created_count += 1
            print(f"   ‚ú® –°–æ–∑–¥–∞–Ω: {short_name} ({key})")

    print("-" * 40)
    print(f"‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print(f"   –°–æ–∑–¥–∞–Ω–æ: {created_count}")
    print(f"   –û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated_count}")
    print(f"   –í—Å–µ–≥–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: {coll.count()}")

if __name__ == "__main__":
    sync_full_group()
