#!/usr/bin/env python3
"""
–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –í–ª–∞–¥–µ–Ω–∏–µ-–í —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º (—ç—Ç–∞–ª–æ–Ω–æ–º)
"""

import pandas as pd
from pathlib import Path

# –ü—É—Ç–∏
SIMPLE_FILE = Path("/opt/docagent/data/osv_revenue_0925/input/–ù–æ—Ä–º_9.2025 –í–ª–∞–¥–µ–Ω–∏–µ-–í.xlsx")
NORMALIZED_FILE = Path("/opt/docagent/data/osv_revenue_0925/output/normalized_osv.xlsx")

def compare_vladenie_v():
    print("=" * 100)
    print("üîç –°–†–ê–í–ù–ï–ù–ò–ï –ù–û–†–ú–ê–õ–ò–ó–û–í–ê–ù–ù–´–• –î–ê–ù–ù–´–• –° –≠–¢–ê–õ–û–ù–û–ú (–í–õ–ê–î–ï–ù–ò–ï-–í)")
    print("=" * 100)
    
    # –ß–∏—Ç–∞–µ–º —ç—Ç–∞–ª–æ–Ω–Ω—ã–π —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    print("\nüìÇ –ß–∏—Ç–∞–µ–º —ç—Ç–∞–ª–æ–Ω–Ω—ã–π —Ñ–∞–π–ª (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)...")
    df_etalon = pd.read_excel(SIMPLE_FILE, engine='openpyxl', header=2)
    
    print(f"‚úÖ –≠—Ç–∞–ª–æ–Ω: {len(df_etalon)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print(f"   –û–±–æ—Ä–æ—Ç –î—Ç: {df_etalon['–û–±–æ—Ä–æ—Ç –î—Ç'].sum():,.2f}")
    print(f"   –°—á–µ—Ç 90:   {df_etalon['90'].sum():,.2f}")
    print(f"   –°—á–µ—Ç 91:   {df_etalon['91'].sum():,.2f}")
    
    # –ß–∏—Ç–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    print("\nüìÇ –ß–∏—Ç–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...")
    df_normalized = pd.read_excel(NORMALIZED_FILE, engine='openpyxl')
    df_norm = df_normalized[df_normalized['–ö–æ–º–ø–∞–Ω–∏—è'] == '–í–ª–∞–¥–µ–Ω–∏–µ-–í'].copy()
    
    print(f"‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ: {len(df_norm)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print(f"   –û–±–æ—Ä–æ—Ç –î—Ç: {df_norm['–û–±–æ—Ä–æ—Ç –î—Ç'].sum():,.2f}")
    print(f"   –°—á–µ—Ç 90:   {df_norm['90'].sum():,.2f}")
    print(f"   –°—á–µ—Ç 91:   {df_norm['91'].sum():,.2f}")
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    print("\n" + "=" * 100)
    print("üìä –°–†–ê–í–ù–ï–ù–ò–ï:")
    print("=" * 100)
    
    diff_count = len(df_etalon) - len(df_norm)
    diff_dt = df_etalon['–û–±–æ—Ä–æ—Ç –î—Ç'].sum() - df_norm['–û–±–æ—Ä–æ—Ç –î—Ç'].sum()
    diff_90 = df_etalon['90'].sum() - df_norm['90'].sum()
    diff_91 = df_etalon['91'].sum() - df_norm['91'].sum()
    
    print(f"\n{'–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å':<20} | {'–≠—Ç–∞–ª–æ–Ω':>15} | {'–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ':>15} | {'–†–∞–∑–Ω–∏—Ü–∞':>15} | –°—Ç–∞—Ç—É—Å")
    print("-" * 100)
    print(f"{'–î–æ–∫—É–º–µ–Ω—Ç–æ–≤':<20} | {len(df_etalon):>15} | {len(df_norm):>15} | {diff_count:>15} | {'‚úÖ' if diff_count == 0 else '‚ùå'}")
    print(f"{'–û–±–æ—Ä–æ—Ç –î—Ç':<20} | {df_etalon['–û–±–æ—Ä–æ—Ç –î—Ç'].sum():>15,.2f} | {df_norm['–û–±–æ—Ä–æ—Ç –î—Ç'].sum():>15,.2f} | {diff_dt:>15,.2f} | {'‚úÖ' if abs(diff_dt) < 1 else '‚ùå'}")
    print(f"{'–°—á–µ—Ç 90':<20} | {df_etalon['90'].sum():>15,.2f} | {df_norm['90'].sum():>15,.2f} | {diff_90:>15,.2f} | {'‚úÖ' if abs(diff_90) < 1 else '‚ùå'}")
    print(f"{'–°—á–µ—Ç 91':<20} | {df_etalon['91'].sum():>15,.2f} | {df_norm['91'].sum():>15,.2f} | {diff_91:>15,.2f} | {'‚úÖ' if abs(diff_91) < 1 else '‚ùå'}")
    
    # –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º
    if abs(diff_dt) >= 1:
        print("\n" + "=" * 100)
        print("üîç –î–ï–¢–ê–õ–¨–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï –ü–û –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê–ú:")
        print("=" * 100)
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º
        etalon_by_ctr = df_etalon.groupby('–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç').agg({
            '–û–±–æ—Ä–æ—Ç –î—Ç': 'sum',
            '90': 'sum',
            '91': 'sum'
        }).reset_index()
        
        norm_by_ctr = df_norm.groupby('–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç').agg({
            '–û–±–æ—Ä–æ—Ç –î—Ç': 'sum',
            '90': 'sum',
            '91': 'sum'
        }).reset_index()
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º
        comparison = etalon_by_ctr.merge(
            norm_by_ctr, 
            on='–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', 
            how='outer', 
            suffixes=('_—ç—Ç–∞–ª–æ–Ω', '_–Ω–æ—Ä–º')
        ).fillna(0)
        
        comparison['–†–∞–∑–Ω–∏—Ü–∞_–î—Ç'] = comparison['–û–±–æ—Ä–æ—Ç –î—Ç_—ç—Ç–∞–ª–æ–Ω'] - comparison['–û–±–æ—Ä–æ—Ç –î—Ç_–Ω–æ—Ä–º']
        comparison['–†–∞–∑–Ω–∏—Ü–∞_90'] = comparison['90_—ç—Ç–∞–ª–æ–Ω'] - comparison['90_–Ω–æ—Ä–º']
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è–º–∏
        diff_rows = comparison[
            (comparison['–†–∞–∑–Ω–∏—Ü–∞_–î—Ç'].abs() >= 1) | 
            (comparison['–†–∞–∑–Ω–∏—Ü–∞_90'].abs() >= 1)
        ]
        
        if len(diff_rows) > 0:
            print("\n‚ùå –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã —Å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è–º–∏:")
            for _, row in diff_rows.iterrows():
                print(f"\n  –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {row['–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç']}")
                print(f"    –û–±–æ—Ä–æ—Ç –î—Ç:  —ç—Ç–∞–ª–æ–Ω={row['–û–±–æ—Ä–æ—Ç –î—Ç_—ç—Ç–∞–ª–æ–Ω']:>12,.2f}  –Ω–æ—Ä–º={row['–û–±–æ—Ä–æ—Ç –î—Ç_–Ω–æ—Ä–º']:>12,.2f}  —Ä–∞–∑–Ω–∏—Ü–∞={row['–†–∞–∑–Ω–∏—Ü–∞_–î—Ç']:>12,.2f}")
                print(f"    –°—á–µ—Ç 90:    —ç—Ç–∞–ª–æ–Ω={row['90_—ç—Ç–∞–ª–æ–Ω']:>12,.2f}  –Ω–æ—Ä–º={row['90_–Ω–æ—Ä–º']:>12,.2f}  —Ä–∞–∑–Ω–∏—Ü–∞={row['–†–∞–∑–Ω–∏—Ü–∞_90']:>12,.2f}")
        else:
            print("\n‚úÖ –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –ø–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!")
    else:
        print("\n‚úÖ –í–°–Å –°–û–í–ü–ê–î–ê–ï–¢! –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!")


if __name__ == "__main__":
    compare_vladenie_v()
