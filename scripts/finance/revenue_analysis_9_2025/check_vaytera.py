#!/usr/bin/env python3
"""
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –í–∞–π—Ç–µ—Ä–∞
"""

import pandas as pd
from pathlib import Path

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
NORMALIZED_FILE = Path("/opt/docagent/data/osv_revenue_0925/output/normalized_osv.xlsx")

# –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –≥—Ä—É–ø–ø—ã
GROUP_COMPANIES = [
    "–ê–ª—å—è–Ω—Å", "–ê–õ–¨–Ø–ù–° –û–û–û",
    "–ë–æ—Å", "–ë–û–° –û–û–û",
    "–í–§–¶", "–í–§–¶ –û–û–û",
    "–í–∞–π—Ç–µ—Ä–∞", "–í–ê–ô–¢–ï–†–ê –û–û–û",
    "–í–ª–∞–¥–µ–Ω–∏–µ-–í", "–í–õ–ê–î–ï–ù–ò–ï-–í –û–û–û",
    "–ì–ì–î–ò", "–ì–†–û–°–° –ì–†–£–ü –î–ò –û–û–û",
    "–ì–ì–ú", "–ì–†–û–°–° –ì–†–£–ü –ú –û–û–û",
    "–ì—Ä–∞–Ω–¥–ø—Ä–æ–º", "–ì–†–ê–ù–î–ü–†–û–ú –ê–û",
    "–î–∂—É–ª –õ–∞–π—Ñ", "–î–ñ–£–õ –õ–ê–ô–§ –û–û–û",
    "–ö-–°—Ç—Ä–æ–π", "–ö-–°–¢–†–û–ô –ê–û",
    "–ú–æ–Ω–æ–ª–∏—Ç", "–ú–û–ù–û–õ–ò–¢ –û–û–û",
    "–°–ì–ö-–†–µ–≥–∏–æ–Ω", "–°–ì–ö-–†–ï–ì–ò–û–ù –û–û–û",
    "–£–ö –ì—Ä–æ—Å—Å", "–£–ö –ì–†–û–°–° –û–û–û",
    "–§–µ—Ç–µ—Ä", "–§–ï–¢–ï–† –û–û–û",
    "–®–∏–Ω–¥—è–ø–∏–Ω", "–®–ò–ù–î–Ø–ü–ò–ù –û–û–û",
    "–Æ–≥-–ò—Å—Ç–µ–π—Ç", "–Æ–ì –ò–°–¢–ï–ô–¢", "–Æ–ì-–ò–°–¢–ï–ô–¢", "–Æ–ì –ò–°–¢–ï–ô–¢ –ò–ù–ñ–ò–ù–ò–†–ò–ù–ì –û–û–û"
]


def is_intercompany(counterparty: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤—ã–º"""
    counterparty_lower = counterparty.lower()
    return any(company.lower() in counterparty_lower for company in GROUP_COMPANIES)


def check_vaytera():
    print("="*80)
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏: –í–ê–ô–¢–ï–†–ê")
    print("="*80)
    
    # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    df = pd.read_excel(NORMALIZED_FILE, engine='openpyxl')
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –í–∞–π—Ç–µ—Ä–∞
    vaytera = df[df['–ö–æ–º–ø–∞–Ω–∏—è'] == '–í–∞–π—Ç–µ—Ä–∞'].copy()
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –≤—ã—Ä—É—á–∫–æ–π
    vaytera = vaytera[(vaytera['90'] > 0) | (vaytera['91'] > 0)].copy()
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    vaytera['–í—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–æ'] = vaytera['90'].fillna(0) + vaytera['91'].fillna(0)
    vaytera['–¢–∏–ø'] = vaytera['–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç'].apply(
        lambda x: 'üîÑ –í–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤–∞—è' if is_intercompany(x) else '‚úÖ –í–Ω–µ—à–Ω—è—è'
    )
    
    print(f"\nüìä –í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –≤—ã—Ä—É—á–∫–æ–π: {len(vaytera)}")
    print(f"   üîÑ –í–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤—ã—Ö: {len(vaytera[vaytera['–¢–∏–ø'] == 'üîÑ –í–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤–∞—è'])}")
    print(f"   ‚úÖ –í–Ω–µ—à–Ω–∏—Ö: {len(vaytera[vaytera['–¢–∏–ø'] == '‚úÖ –í–Ω–µ—à–Ω—è—è'])}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    internal = vaytera[vaytera['–¢–∏–ø'] == 'üîÑ –í–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤–∞—è']
    external = vaytera[vaytera['–¢–∏–ø'] == '‚úÖ –í–Ω–µ—à–Ω—è—è']
    
    print(f"\nüí∞ –í—ã—Ä—É—á–∫–∞ –í–∞–π—Ç–µ—Ä—ã:")
    print(f"   –í—Å–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ:      {vaytera['–í—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–æ'].sum():>15,.2f} —Ä—É–±.")
    print(f"   üîÑ –í–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤–∞—è:   {internal['–í—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–æ'].sum():>15,.2f} —Ä—É–±.")
    print(f"   ‚úÖ –í–Ω–µ—à–Ω—è—è:           {external['–í—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–æ'].sum():>15,.2f} —Ä—É–±.")
    
    # –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
    print("\n" + "="*80)
    print("üìã –°–ü–ò–°–û–ö –í–°–ï–• –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í –í–ê–ô–¢–ï–†–´:")
    print("="*80)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –≤–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤—ã–µ, –ø–æ—Ç–æ–º –≤–Ω–µ—à–Ω–∏–µ
    vaytera_sorted = vaytera.sort_values(['–¢–∏–ø', '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', '–î–æ–∫—É–º–µ–Ω—Ç'])
    
    for idx, row in vaytera_sorted.iterrows():
        print(f"\n{row['–¢–∏–ø']} | {row['–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç']}")
        print(f"   –î–æ–∫—É–º–µ–Ω—Ç: {row['–î–æ–∫—É–º–µ–Ω—Ç']}")
        print(f"   –°—á–µ—Ç 90: {row['90']:>12,.2f}  |  –°—á–µ—Ç 91: {row['91']:>12,.2f}  |  –ò—Ç–æ–≥–æ: {row['–í—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–æ']:>12,.2f}")
        print(f"   –û–ø–ª–∞—Ç–∞:  {row['51']:>12,.2f}  |  –°–∞–ª—å–¥–æ –Ω–∞ –∫–æ–Ω–µ—Ü: {row['–ö–æ–Ω–µ—á–Ω–æ–µ —Å–∞–ª—å–¥–æ –î—Ç']:>12,.2f}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    output_file = Path("/opt/docagent/data/osv_revenue_0925/output/check_vaytera.xlsx")
    
    # –í—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    export_df = vaytera_sorted[[
        '–¢–∏–ø', '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', '–î–æ–∫—É–º–µ–Ω—Ç', 
        '–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–∞–ª—å–¥–æ –î—Ç', '90', '91', '–í—ã—Ä—É—á–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–æ', 
        '51', '–ö–æ–Ω–µ—á–Ω–æ–µ —Å–∞–ª—å–¥–æ –î—Ç'
    ]].copy()
    
    export_df.to_excel(output_file, index=False, engine='openpyxl')
    
    print("\n" + "="*80)
    print(f"üíæ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file}")
    print("="*80)


if __name__ == "__main__":
    check_vaytera()
