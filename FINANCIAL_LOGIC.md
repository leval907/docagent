# Финансовая Логика и Моделирование

Этот документ описывает логику формирования финансовых отчетов (ДДС, ОПУ) и процесс элиминации внутригрупповых оборотов на базе графовой модели ArangoDB.

## 1. План Счетов и Маппинг (Chart of Accounts)

Для автоматического построения отчетов необходимо связать бухгалтерские счета (РСБУ) с аналитическими статьями.

### Структура Справочника `Accounts`
| Счет | Название | Тип | Раздел Баланса |
| :--- | :--- | :--- | :--- |
| 50 | Касса | Активный | Денежные средства |
| 51 | Расчетные счета | Активный | Денежные средства |
| 60 | Расчеты с поставщиками | Пассивный | Кредиторская задолженность |
| 62 | Расчеты с покупателями | Активный | Дебиторская задолженность |
| 90.01 | Выручка | Пассивный | Прибыли и убытки |

### Логика Маппинга Транзакций
Каждая транзакция (ребро графа) имеет атрибуты `dt` (Дебет) и `kt` (Кредит).

*   **ДДС (Cash Flow)**: Анализируются проводки, где корреспондируют счета денежных средств (50, 51, 52).
    *   Приток (Inflow): Дт 51 - Кт 62 (Поступление от покупателя).
    *   Отток (Outflow): Дт 60 - Кт 51 (Оплата поставщику).
*   **ОПУ (P&L)**: Анализируются счета реализации и затрат (90, 91, 20, 26, 44).
    *   Выручка (Revenue): Кт 90.01.
    *   Себестоимость (COGS): Дт 90.02.

## 2. Статьи Затрат и ДДС (Cost Items)

Справочник `CostItems` позволяет группировать транзакции в понятные бизнес-категории.

### Пример Структуры
*   **Операционная деятельность**
    *   Выручка от реализации
    *   Оплата сырья и материалов
    *   ФОТ (Зарплата)
    *   Налоги
*   **Инвестиционная деятельность**
    *   Покупка ОС
*   **Финансовая деятельность**
    *   Кредиты и займы

### Алгоритм Классификации
1.  **По счетам**: Если Дт 60 - Кт 51 -> "Оплата поставщикам".
2.  **По контрагенту**: Если контрагент "ФНС" -> "Налоги".
3.  **По назначению платежа**: Поиск ключевых слов ("зарплата", "аренда") в тексте назначения.

## 3. Элиминация Внутригрупповых Оборотов (Elimination)

Для получения консолидированной отчетности необходимо исключить обороты между компаниями группы.

### Логика
1.  Определить периметр консолидации (список компаний группы). В графе это вершины с атрибутом `type: 'internal'`.
2.  Найти транзакции, где И Отправитель (`_from`), И Получатель (`_to`) входят в периметр.
3.  Пометить такие транзакции флагом `is_intercompany: true` или исключить их при агрегации.

### Пример AQL для Консолидированного ДДС
```aql
FOR t IN Transactions
    // Проверяем, является ли транзакция движением денег
    FILTER t.dt IN ['50', '51', '52'] OR t.kt IN ['50', '51', '52']
    
    // Получаем участников
    LET sender = DOCUMENT(t._from)
    LET receiver = DOCUMENT(t._to)
    
    // Элиминация: Исключаем, если оба участника - наши компании
    FILTER NOT (sender.type == 'internal' AND receiver.type == 'internal')
    
    // Агрегация по статьям
    COLLECT article = t.cost_item_id AGGREGATE total = SUM(t.amount)
    RETURN { article, total }
```

## 4. Связь с Балансом

Баланс строится на определенную дату как сальдо по счетам.

*   **Актив**: Сальдо дебетовое по активным счетам (01, 10, 51, 62...).
*   **Пассив**: Сальдо кредитовое по пассивным счетам (60, 66, 80...).

В графовой модели баланс — это состояние вершин `Accounts` (или агрегат транзакций) на момент времени T.
Для быстрого построения баланса рекомендуется хранить **прекалькулированные сальдо** (Snapshots) на конец каждого месяца в отдельной коллекции `BalanceSnapshots`.
