# Stage 1: Financial Analytics System Core

## 1. Обзор системы
Система предназначена для глубокого финансового анализа предприятий на основе данных РСБУ и управленческой отчетности. Ядро системы построено на графовой базе данных ArangoDB, что позволяет гибко моделировать связи между счетами, транзакциями, контрагентами и аналитическими показателями.

## 2. Архитектура Базы Данных (ArangoDB)
База данных: `finance_analytics`

### Коллекции (Vertices)
*   **Companies**: Юридические лица.
*   **Accounts**: План счетов (РСБУ) с расширенной классификацией:
    *   Привязка к строкам Баланса (1150, 1230 и т.д.).
    *   Группы ликвидности (A1-A4, P1-P4).
    *   Управленческие категории (Cash, Debt, Equity, TradePayables).
    *   Логика Актив/Пассив для субсчетов (например, 60.01 vs 60.02).
*   **Dictionary**: Финансовый словарь терминов, связанный со счетами.
*   **FinancialData**: Хранилище финансовых отчетов (P&L + Balance Sheet).
*   **Analytics**: Рассчитанные аналитические показатели и сценарии.
*   **CostItems**, **Contracts**, **Projects**: Справочники аналитики.

### Связи (Edges)
*   **Transactions**: Финансовые проводки.
*   **RelatedTo**: Связь терминов словаря со счетами.
*   **ClassifiedAs**, **SignedBy**, **AllocatedTo**: Дополнительные аналитические связи.

## 3. Модели Данных и Логика Расчетов

### A. FinancialReport (Исходные данные и Базовые расчеты)
Автоматический расчет структуры P&L и Баланса при загрузке:
*   **P&L**: Gross Margin, Operating Profit, EBITDA, Net Profit, Retained Profit.
*   **Balance Sheet**: Агрегация оборотных/внеоборотных активов и обязательств.

### B. AnalyticsReport (Глубокая Аналитика)
Фабрика аналитики, генерирующая отчет на основе `FinancialReport`.

#### 1. Финансовые Коэффициенты (22+ показателя)
*   **Рентабельность**: Gross Margin %, Operating Profit %, Net Profit %, ROE, ROA, ROCE.
*   **Оборотный капитал**: Working Capital Days, AR Days, Inventory Days, AP Days, Cash Conversion Cycle.
*   **Ликвидность и Устойчивость**: Current Ratio, Debt to Equity (Net Debt), Interest Cover.

#### 2. Power of One (Анализ чувствительности)
Моделирование влияния изменений на 1% (или 1 день) на Прибыль и Денежный поток:
*   **Price / Volume / COGS / Overheads**: Влияние на Operating Profit.
*   **AR / Inventory / AP Days**: Влияние на Cash Flow.

#### 3. Business Value Indicator (Оценка бизнеса)
*   Расчет стоимости бизнеса на основе EBITDA и мультипликаторов.
*   Учет чистого долга (Net Debt).
*   Сценарный анализ стоимости.

## 4. Текущий статус (Stage 1 Complete)
*   ✅ Развернута новая структура БД `finance_analytics`.
*   ✅ Загружен и классифицирован План счетов (449 позиций).
*   ✅ Интегрирован Финансовый словарь (44 термина).
*   ✅ Реализованы модели данных Pydantic с валидацией и формулами.
*   ✅ Написаны и пройдены тесты логики на реальных данных (Rebecca's Coffee 2018).

## 5. Следующие шаги
*   Загрузка транзакционных данных (OSV).
*   Построение графа проводок.
*   Запуск API для фронтенда.
